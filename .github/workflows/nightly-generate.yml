name: Nightly Model Generation

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-models:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"
      
      - name: Generate models
        run: |
          python scripts/generate_models.py
      
      - name: Create or update pull request
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate connector models"
          title: "chore: nightly regeneration of connector models"
          body: |
            This PR was automatically generated by the nightly model generation workflow.
            
            The workflow regenerates connector models from the latest Airbyte connector specifications.
            
            If tests pass, this PR will be automatically merged.
          branch: automation/nightly-model-regeneration
          delete-branch: true
          add-paths: |
            airbyte_connector_models/connectors/
      
      - name: Enable auto-merge
        if: steps.create_pr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash
